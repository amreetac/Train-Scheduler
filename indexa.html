<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Sign-Up Today!</title>

	<!-- Bootstrap -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
	
	<script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
	<link rel="stylesheet" type="text/css" href="assets/css/style.css">

	<script src="https://cdn.firebase.com/js/client/2.4.1/firebase.js"></script>

		<!-- Moment.js Reference -->
	<!-- <script src="http://momentjs.com/downloads/moment.js"></script> -->	
 	<script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>


</head>
<body>

<div class="container">

<br>

<div class="jumbotron">
		<h1>Anytime is Train Time</h1>
	 	<h2>Choo Choo Chee Chee</h2>
	 	<p></p>
	</div>


	
	<div class="panel panel-primary">
 		<div class="panel-heading">
 		  <h3 class="panel-title">Current Train Schedule</h3>
 		</div>
		<div class="panel-body">

		<!-- Table -->
 		<table class="table" id="trainTable">
 			<th> Train Name</th>
 			<th> Destination</th>
 			<th> Frequency (min) </th>
 			<th> Next Arrival</th>
 			<th> Minutes Away</th>
 		</table>
   		
 		</div>

 		</div>

 		<br>

 		<div class="panel panel-primary">
		<div class="panel-heading">
 		  <h3 class="panel-title">Add Train</h3>
 		</div>

		<div class="panel-body">

	 		<form>
				 <div class="form-group">
				   <label for="inputTrain">Train Name</label>
				   <input type="text" class="form-control" id="name" >
				 </div>

				 <div class="form-group">
				   <label for="inputDest">Destination</label>
				   <input type="text" class="form-control" id="dest" >
				 </div>
				 
				 <div class="form-group">
				   <label for="inputTime">First Train Time (HH:mm - military time)</label>
				   <input type="text" class="form-control" id="time" >
				 </div>

				 <div class="form-group">
				   <label for="inputFrequency">Frequency (mm) </label>
				   <input type="text" class="form-control" id="frequency" >
				 </div>
				 
				 
				 
				 <button type="submit" id="submitBtn" class="btn btn-primary">Submit</button>
			</form>

		</div>
		


	</div>

<script>


	$( document ).ready(function() {
		var dataRef = new Firebase("https://train-scheduler2.firebaseio.com/");

var name = "";
var dest = "";
var time = 0;
var frequency = 0;
var tMinutesTillTrain = 0;
var nextTrain = 0;

	

 $("#submitBtn").on("click", function(){

       // Get inputs
       name = $('#name').val().trim(); 
       dest = $('#dest').val().trim(); 
       time = moment($('#time').val().trim(), "HH:mm").format("X");
       frequency = $('#frequency').val().trim();


// First Time (pushed back 1 year to make sure it comes before current time)
	   		var firstTimeConverted = moment(time,"hh:mm").subtract(1, "years");
	   		console.log(firstTimeConverted);
	   		// Current Time
	   		var currentTime = moment();
	   		console.log("CURRENT TIME: " + moment(currentTime).format("hh:mm"));
	   		// Difference between the times
	   		var diffTime = moment().diff(moment(firstTimeConverted), "minutes");
	   		console.log("DIFFERENCE IN TIME: " + diffTime);
	   		// Time apart (remainder)
	   		var tRemainder = diffTime % tFrequency;
	   		console.log(tRemainder);
	   		// Minute Until Train
	   		tMinutesTillTrain = frequency - tRemainder;
	   		console.log("MINUTES TILL TRAIN: " + tMinutesTillTrain);
	   		// Next Train
	   		nextTrain = moment().add(tMinutesTillTrain, "minutes")
		console.log("ARRIVAL TIME: " + moment(nextTrain).format("hh:mm"))






       // Change what is saved in firebase
       dataRef.push({
           name: name,
           dest: dest, 
           time: time, 
           frequency: frequency,
           tMinutesTillTrain: tMinutesTillTrain,
           nextTrain: nextTrain
           
       });

       // Alert
	alert("Information successfully added");

	// Clears all of the text-boxes
	$("#name").val("");
	$("#dest").val("");
	$("#time").val("");
	$("#frequency").val("");
	$("#tMinutesTillTrain").val("");
	$("#nextTrain").val("");

       return false;
   });
		
		var counter=0;
dataRef.on("child_added", function(childSnapshot, prevChildkey) {
	// Log everything that's coming out of snapshot
	counter++;
	console.log(counter);
	//console.log(snapshot);
	console.log(childSnapshot.val());
	console.log(childSnapshot.val().name);
	console.log(childSnapshot.val().dest);
	console.log(childSnapshot.val().time);
	console.log(childSnapshot.val().frequency);
	console.log(childSnapshot.val().tMinutesTillTrain);
	console.log(childSnapshot.val().nextTrain);
		// Store everything into a variable.
	var trainName = childSnapshot.val().name;
	var Destination= childSnapshot.val().dest;
	var trainTime = childSnapshot.val().time;
	var Frequency = childSnapshot.val().frequency;
	var tMinutesTillTrain = childSnapshot.val().tMinutesTillTrain;
	var nextTrain = childSnapshot.val().nextTrain;


// Add each train's data into the table
$("#trainTable").append("<tr><td>" + trainName + "</td><td>" + Destination + "</td><td>" + Frequency+
	"</td><td>"  +tMinutesTillTrain+ "</td><td>"  +nextTrain+ "</td><td>"  + "</td></tr>");


var tableRow = $("<tr>");
	var tableData1 = $("<td>");
	tableData1.html(trainName);
	var tableData2 = $("<td>");
	tableData2.html(Destination);
	var tableData3 = $("<td>");
	tableData3.html(Frequency);
	var tableData4 = $("<td>");
	tableData4.html(tMinutesTillTrain);
	var tableData5 = $("<td>");
	tableData5.html(nextTrain);
	tableRow.append(tableData1);
	tableRow.append(tableData2);
	tableRow.append(tableData3);
	tableRow.append(tableData4);
	tableRow.append(tableData5);
	$("#employeeTable > tbody").append(tableRow);

});

// Handle the errors
}, function(errorObject) {
	console.log("Errors handled: " + errorObject.code);
});
			



	</script>



</body>
</html>